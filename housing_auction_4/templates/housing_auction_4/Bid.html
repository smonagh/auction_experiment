{% extends "global/Page.html" %}
{% load staticfiles otree %}

{% block content %}
<h1>Auction</h1>

<!-- Defines table for buyer types in full information -->
{% if player_type == 'buyer' and treatment == 'full_information' %}
{% block bid_buyer_full %}
{% endblock %}
<!-- Defines table for seller types in full information -->
{% elif player_type == 'seller' and treatment == 'full_information' %}
{% block bid_seller_full %}
{% endblock %}
<!-- Defines table for buyer type in no information -->
{% elif player_type == 'buyer' and treatment == 'no_information' %}
{% block bid_buyer_no %}
{% endblock %}
<!-- Defines table for seller type in no information -->
{% elif player_type == 'seller' and treatment == 'no_information' %}
{% block bid_seller_no %}
{% endblock %}
{% endif %}

<!-- Hidden submit button -->
<button id="page_submit" class="btn" type="submit" style="display:none"></button>

{% endblock %}
{% block scripts %}
<script type="text/javascript" src="/static/otree/js/jquery.countdown.min.js"></script>
<!-- Javascript to manage realtime bidding and interface with backend -->
<script>

//Displaying errors in a hidden span on the page (substitute for alert).
function displayError(err){
    $('#ErrorText').text(err);
    $('#ErrorContainer').show();
    setTimeout(function(){$('#ErrorContainer').hide()},5000);
}

//Timeout function. Alert stops the counting, therefore errors are inline instead of alerts.
var timeoutHandle = setInterval(TimeoutTimer, 1000);
var timeout=30;
function TimeoutTimer(){
    timeout=timeout-1; //decrement timer
    if (timeout>1 && timeout<=10){
        //Only show timer when <=10 seconds remain
        $('#TimerText').text(String(timeout));
        $('#TimerContainer').show();
    } else if (timeout>10){
        //Hide timer when >10 seconds remain
        $('#TimerContainer').hide();
    } else if (timeout>-100){
        //Send message that timeout has ended.
        timeout=-100
        console.log('closing for timeout');
        soft_close();
    }
}

//Prevent enter key from submitting the page_submit
//Not optimal but should stop all relevant use cases.
for (i=0;i<10;i++){
  $('#input_'+i).keypress(function(e) {
      if(e.which == 13) { // Checks for the enter key
          e.preventDefault(); // Stops enter from submitting form
      }
  });
};

//set up sockets
var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
var socket = new WebSocket(ws_scheme +
          '://' + window.location.host + "/housing_auction_4/group{{group.id}}");

// Handle any errors that occur.
socket.onerror = function (error) {
          console.log('WebSocket Error: ' + error);
};
// Send initial message once connection is opened
socket.onopen = function () {
  var msg = {identifier:"initial"}
 socket.send(JSON.stringify(msg));
};
// Processes data that is back from the server
socket.onmessage = function (event) {
     var obj = jQuery.parseJSON(event.data);
     // Check to see if all players are done
     if (obj.bid_status == 'done'){
       // If they are then submit page
       $('#page_submit').click();
       console.log(obj);
     };

     // Check to make sure player is not highest bidder
     if (obj.highest_bid == true){
       if (obj.bidder_id == {{player.id_in_subsession}}){
         console.log('warning message')
          displayError('You are currently the highest bidder for a widget');
       };
       // if player is not the highest bidder
    } else {

    // Reset timeout
    if (!obj.hasOwnProperty('bid_status')){
        timeout=30;
    }

    // Show text indicating that player is highest bidder
    if (obj.bidder_id == {{player.id_in_subsession}}){
       console.log(obj.budget);
       $('#highest_bid_'+ obj.id).show();
       $('#highest_bid_amount_'+obj.id).html(obj.bid);
       $('#budget').html(obj.budget);
     }else if (obj.bidder_id != {{player.id_in_subsession}}){
       // Hide text indicating player is highest bidder
       $('#highest_bid_'+obj.id).hide();
     };
   };
   // Update text to reflect new highest bid
   update_price(obj.bid,obj.id);
   };

// Log socket close
socket.onclose = function (event) {
console.log('disconnected from oTree');
};

// Function to send bid data to the backend
sendmessage = function(val,id,current_bid,ask_price,reservation){
        var my_bid = parseInt(document.getElementById(val).value);
        var current_bid = parseInt(current_bid);
        var ask_price = parseInt(ask_price);
        reservation = parseInt(reservation);
        console.log(my_bid,current_bid,ask_price,reservation)
        //Prevent players from submitting a bid greater than their reservation
        if (my_bid > reservation){
             displayError('You can not enter a bid that is greater than your reservation value of '+String(reservation)+' for the widget');
        //Prevent players from submitting a bid that is not improving
        }else if (my_bid <= current_bid) {
            displayError('You have entered bid of '+String(my_bid)+' which is not greater than the standing bid');
        //Return data to backend if none of the previous errors were thrown
        }else if (my_bid > current_bid){

            var msg = {
                identifier: 'bid',
                vars: {
                player_id: {{player.id_in_subsession}},
                id_in_group: {{player.id_in_group}},
                object_id: id,
                bid: my_bid,
                standing_bid: current_bid,
                ask_price: ask_price
              }
            };

            if (socket.readyState === socket.OPEN) {
            socket.send(JSON.stringify(msg))};
        };
      };
//Update html to reflect the new standing bid
update_price = function(bid,id){
    console.log(bid,id)
    $('#current_bid_'+id).html(bid);
    $('#bid_btn_'+id).prop('value');

};

// Turn on text to indicate that player is the highest bidder.
update_highest_bid = function(object_id,bid){
  $('#highest_bid_'+object_id).show();
};

// Javascript function to implement soft close

soft_close = function(){
  var msg = {
    identifier:'close',
    vars:{
      player_id:{{player.id_in_subsession}}
    }
  };
  if (socket.readyState === socket.OPEN) {
    socket.send(JSON.stringify(msg))
  };
  if (1!={{ Constants.end_on_timer }}){
  $('#close_button').hide();
  $('#after_close').show();
  };
};
</script>
{% endblock %}

{% block styles %}
<style>
    table a:link {
	color: #666;
	font-weight: bold;
	text-decoration:none;
}
table a:visited {
	color: #999999;
	font-weight:bold;
	text-decoration:none;
}
table a:active,
table a:hover {
	color: #bd5a35;
	text-decoration:underline;
}
table {
	font-family:Arial, Helvetica, sans-serif;
	color:#666;
	font-size:16px;
	text-shadow: 1px 1px 0px #fff;
	background:#eaebec;
	margin:10px;
	border:#ccc 1px solid;

	-moz-border-radius:3px;
	-webkit-border-radius:3px;
	border-radius:3px;

	-moz-box-shadow: 0 1px 2px #d1d1d1;
	-webkit-box-shadow: 0 1px 2px #d1d1d1;
	box-shadow: 0 1px 2px #d1d1d1;
}
table th {
	padding:15px 19px 15px 19px;
	border-top:1px solid #fafafa;
	border-bottom:1px solid #e0e0e0;

	background: #ededed;
	background: -webkit-gradient(linear, left top, left bottom, from(#ededed), to(#ebebeb));
	background: -moz-linear-gradient(top,  #ededed,  #ebebeb);
}
table th:first-child {
	text-align: left;
	padding-left:20px;
}
table tr:first-child th:first-child {
	-moz-border-radius-topleft:3px;
	-webkit-border-top-left-radius:3px;
	border-top-left-radius:3px;
}
table tr:first-child th:last-child {
	-moz-border-radius-topright:3px;
	-webkit-border-top-right-radius:3px;
	border-top-right-radius:3px;
}
table tr {
	text-align: center;
	padding-left:210px;
}
table td:first-child {
	text-align: left;
	padding-left:20px;
	border-left: 0;
}
table td {
	padding:6px;
	border-top: 1px solid #ffffff;
	border-bottom:1px solid #e0e0e0;
	border-left: 1px solid #e0e0e0;

	background: #fafafa;
	background: -webkit-gradient(linear, left top, left bottom, from(#fbfbfb), to(#fafafa));
	background: -moz-linear-gradient(top,  #fbfbfb,  #fafafa);
}
table tr.even td {
	background: #f6f6f6;
	background: -webkit-gradient(linear, left top, left bottom, from(#f8f8f8), to(#f6f6f6));
	background: -moz-linear-gradient(top,  #f8f8f8,  #f6f6f6);
}
table tr:last-child td {
	border-bottom:0;
}
table tr:last-child td:first-child {
	-moz-border-radius-bottomleft:3px;
	-webkit-border-bottom-left-radius:3px;
	border-bottom-left-radius:3px;
}
table tr:last-child td:last-child {
	-moz-border-radius-bottomright:3px;
	-webkit-border-bottom-right-radius:3px;
	border-bottom-right-radius:3px;
}
table tr:hover td {
	background: #f2f2f2;
	background: -webkit-gradient(linear, left top, left bottom, from(#f2f2f2), to(#f0f0f0));
	background: -moz-linear-gradient(top,  #f2f2f2,  #f0f0f0);
}
.btn{

}
</style>
{% endblock %}
